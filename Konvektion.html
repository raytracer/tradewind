<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Konvektion Animation</title>
</head>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.3.13/p5.js"></script>
<script type="text/javascript">

var posx;
var posy;
var width;
var height;
var points;
var actCirc;
var sunShining;

function setup() {
  createCanvas(displayWidth-10,displayHeight-10);
  smooth();
  
  sunShining = false;
  posx = 0;
  posy = 60;
  if (displayWidth <= 300)
    width = displayWidth-10;
  else width = 300;
  height = displayHeight-110;
  points = [];
  actCirc = [];
  
  var dist = 25;
  for (var i = 0; i < height/dist-1; i++){
      for (var j = 0; j < width/dist-1; j++){
    	  points[11*i+j] = [];
    	  points[11*i+j][0] = posx + 25 + j*dist;
    	  points[11*i+j][1] = posy + 25 + i*dist;
      }
  }
  console.log("w: " + displayWidth +", h: "+displayHeight);
}

function draw() {
    //The sun
    fill(255, 255, 0);
    stroke(255);
    ellipse(posx + width/2,-100,width,width);
    //der Kasten
    fill(255);
    stroke(0);
    rect(posx,posy,width,height);

    drawPoints();
    evaluate();
    if (sunShining)
        heating();
    else shakePoints(1);
}

function drawPoints(){
	fill(0);
	stroke(0);
	for (var i = 0; i < points.length; i++){
		ellipse(points[i][0],points[i][1],5,5);
	}
}
function shakePoints(action){
    for (var i = 0; i< points.length; i++){
        points[i][0] = points[i][0] + random(-action,action);
        //Horizontal Border
        if (points[i][0] < posx + 5)
            points[i][0] = posx + 5;
        else if(points[i][0] > posx+width-5)
            points[i][0] = posx+width-5;

        points[i][1] = points[i][1] + random(-action,action);
        //Vertical Border
        if (points[i][1] < posy + 5)
            points[i][1] = posy + 5;
        else if(points[i][1] > posy+height-5)
            points[i][1] = posy+height-5;
    }
}
function heating(){
	//let the Sun shining
	stroke(255, 255, 0, 64);
	strokeWeight(5);
	line (posx + width*4/16,-100,posx, posy+height);
    line (posx + width*5/16,-100,posx+width*1/8, posy+height);
    line (posx + width*6/16,-100,posx+width*1/4, posy+height);
    line (posx + width*7/16,-100,posx+width*3/8, posy+height);
    line (posx + width*8/16,-100,posx+width/2, posy+height);
    line (posx + width*9/16,-100,posx+width*5/8, posy+height);
    line (posx + width*10/16,-100,posx+width*3/4, posy+height);
    line (posx + width*11/16,-100,posx+width*7/8, posy+height);
    line (posx + width*12/16,-100,posx+width, posy+height);
    stroke(255,0,0);
    strokeWeight(5);
    line(posx,posy+height,posx+width,posy+height);
    
    //shake and rising
    for (var i = 0; i< points.length; i++){
    	var action = (points[i][1]-posy)/height*3+0.5;
        
        //The x-Value
        points[i][0] = points[i][0] + random(-action,action);
        if (points[i][0] < posx + 5)
            points[i][0] = posx + 5;
        else if(points[i][0] > posx+width-5)
            points[i][0] = posx+width-5;
        
        //The y-Value
        var o = checkRiseOrientation(points[i][1]);
        if (o == -1)
            points[i][1] = points[i][1] + random(-action,action*1.3);
        else if (o == 0)
        	points[i][1] = points[i][1] + random(-action,action);
        else if (o == +1)
        	points[i][1] = points[i][1] + random(-action*1.3,action);
        if (points[i][1] < posy + 5)
            points[i][1] = posy + 5;
        else if(points[i][1] > posy+height-5)
            points[i][1] = posy+height-5;
    }
}
//prueft wohin die Punkte wandern sollen
function checkRiseOrientation(h){
    if (posy < h && h < posy+height*1/6 && actCirc[0] > 70 && actCirc[1] < 55)
		return -1;
    if (posy+height*1/6 < h && h < posy+height*2/6 && actCirc[1] > 57)
    	if (actCirc[2] < 47)
    		return -1;
    	else return 1;
    if (posy+height*2/6 < h && h < posy+height*3/6 && actCirc[2] > 47)
        if (actCirc[3] < 37)
            return -1;
        else return 1;
    if (posy+height*3/6 < h && h < posy+height*4/6 && actCirc[3] > 37)
        if (actCirc[4] < 27)
            return -1;
        else return 1;
    if (posy+height*4/6 < h && h < posy+height*5/6 && actCirc[4] > 27)
        if (actCirc[5] < 17)
            return -1;
        else return 1;
    if (posy+height*5/6 < h && h < posy+height && actCirc[5] > 17)
            return 1;
    return 0;
}

//zaehlt die Punkte pro 1/6 um zu verschieben
function evaluate(){
    for (var i = 0; i < 6; i++)
        actCirc[i]=0;
    for (var i = 0 ; i < points.length; i++){
        var h = points[i][1];
        if (h < posy+height*1/6)
            actCirc[0]++;
        else if (h<posy+height*2/6)
            actCirc[1]++;
        else if (h<posy+height*3/6)
            actCirc[2]++;
        else if(h<posy+height*4/6)
            actCirc[3]++;
        else if (h<posy+height*5/6)
            actCirc[4]++;
        else actCirc[5]++;
    }
    //if (frameCount%50==0)
    //    for (var i = 0; i<actCirc.length; i++)
    //        console.log(i+": " + actCirc[i]);
}
function mousePressed(){
    var d= dist(mouseX, mouseY, posx + width/2, -100 );
        if (d < width){
            if (sunShining)
                setup();
            else sunShining = true;
        }
				
}
</script>
</body>
</html>
